package com.epay.merchant.validator;

import com.epay.merchant.dao.LoginDao;
import com.epay.merchant.dto.ErrorDto;
import com.epay.merchant.model.request.MerchantLoginRequest;
import com.epay.merchant.util.ErrorConstants;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.util.ArrayList;

import static com.epay.merchant.util.ErrorConstants.*;

/**
 * Class Name: MerchantLoginValidator
 * *
 * Description:  MerchantLoginValidator is responsible for validating the merchant login request,
 * including mandatory fields, user existence, and captcha.
 * *
 * Author: Ravi Rathore
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */

@Component
@RequiredArgsConstructor
public class MerchantLoginValidator extends BaseValidator {

    private final LoggerUtility logger = LoggerFactoryUtility.getLogger(this.getClass());

    private final LoginDao loginDao;
    private final CaptchaValidator captchaValidator;
    private final ValidationValidator validationValidator;

    /**
     * Validates the merchant login request, including mandatory fields,user existence and captcha validation
     *
     * @param merchantLoginRequest MerchantLoginRequest The login request to validate.
     */
    public void validateMerchantLoginRequest(MerchantLoginRequest merchantLoginRequest) {
        logger.debug("Merchant validation start for {}", merchantLoginRequest);
        errorDtoList = new ArrayList<>();
        validateMandatoryFields(merchantLoginRequest);
        logger.debug("Mandatory validation completed for {}", merchantLoginRequest);
        captchaValidator.captchaValueValidation(merchantLoginRequest.getRequestId(), merchantLoginRequest.getCaptchaText());
        logger.debug("captcha validation completed for {}", merchantLoginRequest);
        isUserExist(merchantLoginRequest);
        logger.debug("user check validation completed for {}", merchantLoginRequest);
        validationValidator.validatedMerchantUser(merchantLoginRequest.getUserName());
        logger.debug("user status check completed for {}", merchantLoginRequest);
    }

    /**
     * Validates the all the mandatory fields in the merchantLoginRequest
     *
     * @param merchantLoginRequest MerchantLoginRequest
     */
    private void validateMandatoryFields(MerchantLoginRequest merchantLoginRequest) {
        checkMandatoryField(merchantLoginRequest.getUserName(), USER_NAME);
        checkMandatoryField(merchantLoginRequest.getPassword(), ErrorConstants.PSW);
        checkMandatoryField(merchantLoginRequest.getCaptchaText(), CAPTCHA_TEXT);
        checkMandatoryField(String.valueOf(merchantLoginRequest.getRequestId()), ErrorConstants.REQUEST_ID);
        throwIfErrors();
    }

    /**
     * Validates if the user exists based on the provided login request
     *
     * @param merchantLoginRequest MerchantLoginRequest
     */
    private void isUserExist(MerchantLoginRequest merchantLoginRequest) {
        boolean merchantUserExistsByUserNameAndPassword = loginDao.isMerchantUserExistsByUserNameAndPassword(merchantLoginRequest.getUserName(), merchantLoginRequest.getPassword());
        if (!merchantUserExistsByUserNameAndPassword) {
            errorDtoList.add(ErrorDto.builder().errorCode(NOT_FOUND_ERROR_CODE).errorMessage(LOGIN_USER_NOT_FOUND_ERROR_MESSAGE).build());
        }
        throwIfErrors();
    }


}
