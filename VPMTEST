package com.epay.merchant.service;

import com.epay.merchant.dao.HelpSupportDao;
import com.epay.merchant.dto.HelpSupportDto;
import com.epay.merchant.model.request.HelpSupportRequest;
import com.epay.merchant.model.response.HelpSupportResponse;
import com.epay.merchant.model.response.MerchantResponse;
import com.epay.merchant.util.MerchantConstant;
import com.epay.merchant.validator.HelpSupportValidator;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * Class Name: HelpSupportService
 * *
 * Description:
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@Service
@RequiredArgsConstructor
public class HelpSupportService {

    private final HelpSupportValidator helpSupportValidator;
    private final HelpSupportDao helpSupportDao;

    /**
     * Get Team information.
     *
     * @return OnboardingDto
     */
    public MerchantResponse<HelpSupportResponse> getHelpSupports(String mId) {
        //Step 1 : Validate mId
        helpSupportValidator.validatedHelpSupportMId(mId);
        //Step 2 : Get Help Support Data from DB.
        List<HelpSupportDto> helpSupport = helpSupportDao.getHelpSupports(mId);
        HelpSupportResponse helpSupportResponse = HelpSupportResponse.builder().helpSupports(helpSupport).build();
        //Step 2 : Build MerchantResponse and return to caller
        return MerchantResponse.<HelpSupportResponse>builder().data(List.of(helpSupportResponse)).status(MerchantConstant.RESPONSE_SUCCESS).count(1L).build();
    }

    /**
     * Update Team information.
     *
     * @param mId                String
     * @param helpSupportRequest HelpSupportRequest
     * @return MerchantResponse
     */
    public MerchantResponse<HelpSupportResponse> saveHelpSupport(String mId, HelpSupportRequest helpSupportRequest) {
        //Step 1 : HelpSupportValidator validation
        helpSupportValidator.validateHelpSupportRequest(mId, helpSupportRequest);
        //Step 2 : Save the Merchant and Merchant User Data in DB
        List<HelpSupportDto> helpSupport = helpSupportDao.saveHelpSupport(mId, helpSupportRequest);
        HelpSupportResponse helpSupportResponse = HelpSupportResponse.builder().helpSupports(helpSupport).build();
        //Step 3 : Build MerchantResponse and return to caller
        return MerchantResponse.<HelpSupportResponse>builder().data(List.of(helpSupportResponse)).status(MerchantConstant.RESPONSE_SUCCESS).count(1L).build();
    }
}


package com.epay.merchant.dao;

import com.epay.merchant.dto.HelpSupportDto;
import com.epay.merchant.entity.HelpSupport;
import com.epay.merchant.mapper.HelpSupportMapper;
import com.epay.merchant.model.request.HelpSupportRequest;
import com.epay.merchant.repository.HelpSupportRepository;
import com.epay.merchant.util.enums.MerchantStatus;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import java.util.ArrayList;
import java.util.List;

import static com.epay.merchant.util.MerchantConstant.STATUS_ACTIVE;
import static com.epay.merchant.util.MerchantConstant.STATUS_IN_ACTIVE;

/**
 * Class Name: HelpSupportDao
 * *
 * Description: DB layer logic for Help and Support
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@Component
@RequiredArgsConstructor
public class HelpSupportDao {

    private final LoggerUtility log = LoggerFactoryUtility.getLogger(HelpSupportDao.class);
    private final HelpSupportRepository helpSupportRepository;
    private final MerchantInfoDao merchantInfoDao;
    private final HelpSupportMapper helpSupportMapper;

    /**
     * Creating Help and Support team records in database.
     *
     * @return HelpSupportResponse
     */
    public List<HelpSupportDto> getHelpSupports(String mId) {
        List<HelpSupport> helpSupports = helpSupportRepository.findBymIdAndStatus(mId, STATUS_ACTIVE);
        if (CollectionUtils.isEmpty(helpSupports)) {
            helpSupports = helpSupportRepository.findBymIdIsNull();
        }
        return helpSupportMapper.mapEntityListToDtoList(helpSupports);
    }

    /**
     * Updating Help and Support team record in database.
     *
     * @param mId                String
     * @param helpSupportRequest HelpSupportRequest
     * @return HelpSupportResponse
     */
    @Transactional
    public List<HelpSupportDto> saveHelpSupport(String mId, HelpSupportRequest helpSupportRequest) {
        List<HelpSupport> helpSupports = new ArrayList<>();
        for (HelpSupportDto helpSupportDto : helpSupportRequest.getHelpSupports()) {
            HelpSupport helpSupport = helpSupportRepository.findByMidAndType(mId, helpSupportDto.getType()).orElse(HelpSupport.builder().mId(mId).type(helpSupportDto.getType()).build());
            helpSupport.setValue(helpSupportDto.getValue());
            helpSupport.setStatus(helpSupportDto.isStatus() ? STATUS_ACTIVE : STATUS_IN_ACTIVE);
            helpSupports.add(helpSupport);
        }
        helpSupports = helpSupportRepository.saveAll(helpSupports);
        return helpSupportMapper.mapEntityListToDtoList(helpSupports);
    }

    /**
     * Is MId exist in the system.
     *
     * @param mId String
     * @return boolean
     */
    public boolean isValidMerchant(String mId) {
        return merchantInfoDao.isExistsByMIdAndStatus(mId, MerchantStatus.ACTIVE.name());
    }
}

package com.epay.merchant.model.response;

import com.epay.merchant.dto.HelpSupportDto;
import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

/**
 * Class Name: HelpSupportResponse
 * *
 * Description: To send response of Help and Support.
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@JsonInclude(JsonInclude.Include.NON_NULL)
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class HelpSupportResponse {

    private List<HelpSupportDto> helpSupports;
}
