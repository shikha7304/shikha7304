package com.epay.merchant.service;

import com.epay.merchant.dao.HelpSupportDao;
import com.epay.merchant.dto.HelpSupportTeamDto;
import com.epay.merchant.model.response.HelpSupportResponse;
import com.epay.merchant.model.response.MerchantResponse;
import com.epay.merchant.util.MerchantConstant;
import com.epay.merchant.validator.HelpSupportValidator;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * Class Name: HelpSupportService
 * *
 * Description:
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@Service
@RequiredArgsConstructor
public class HelpSupportService {

    private final HelpSupportValidator helpSupportValidator;
    private final HelpSupportDao helpSupportDao;

    /**
     * Get Team information.
     * @return OnboardingDto
     */
    public MerchantResponse<HelpSupportResponse> getTeamsInfo(String mId) {
        //Step 1 : Get Active teams from DB.
        helpSupportValidator.validateCreateHelpSupportRequest(mId);
        List<HelpSupportResponse> teams = helpSupportDao.getTeam(mId);
        //Step 2 : Build MerchantResponse and return to caller
        return MerchantResponse.<HelpSupportResponse>builder().data(teams).status(MerchantConstant.RESPONSE_SUCCESS).count((long) teams.size()).build();
    }
    /**
     * Update Team information.
     * @param mId String
     * @param helpSupportTeamDto HelpSupportTeamDto
     * @return MerchantResponse
     */
    public MerchantResponse<HelpSupportResponse> updateTeam(String mId, HelpSupportTeamDto helpSupportTeamDto) {
        helpSupportTeamDto.setMId(mId);
        //Step 1 : HelpSupportValidator validation
        helpSupportValidator.validateUpdateHelpSupportRequest(helpSupportTeamDto);
        //Step 2 : Save the Merchant and Merchant User Data in DB
        HelpSupportResponse helpSupportResponses = helpSupportDao.updateTeam(helpSupportTeamDto);
        //Step 3 : Build MerchantResponse and return to caller
        return MerchantResponse.<HelpSupportResponse>builder().data(List.of(helpSupportResponses)).status(MerchantConstant.RESPONSE_SUCCESS).count(1L).build();
    }
}

package com.epay.merchant.dao;

import com.epay.merchant.dto.HelpSupportTeamDto;
import com.epay.merchant.entity.*;
import com.epay.merchant.mapper.MerchantMapper;
import com.epay.merchant.model.response.HelpSupportResponse;
import com.epay.merchant.repository.*;
import com.epay.merchant.util.DateTimeUtils;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.util.List;

import static com.epay.merchant.util.MerchantConstant.STATUS_ACTIVE;

/**
 * Class Name: HelpSupportDao
 * *
 * Description: DB layer logic for Help and Support
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@Component
@RequiredArgsConstructor
public class HelpSupportDao {

    private final LoggerUtility log = LoggerFactoryUtility.getLogger(HelpSupportDao.class);
    private final HelpSupportTeamRepository helpSupportTeamRepository;
    private final MerchantInfoRepository merchantInfoRepository;
    private final MerchantMapper mapper;

    /**
     * Creating Help and Support team records in database.
     * @return HelpSupportResponse
     */
    public List<HelpSupportResponse> getTeam(String mId) {
        List<HelpSupportTeam> helpSupportTeams = helpSupportTeamRepository.findByMid(mId);
        return helpSupportTeams.stream().map(mapper::mapHelpSupportTeamEntityToResponse).toList();
    }

    /**
     * Updating Help and Support team record in database.
     * @param helpSupportDto HelpSupportDto
     * @return HelpSupportResponse
     */
    @Transactional
    public HelpSupportResponse updateTeam(HelpSupportTeamDto helpSupportDto) {
        HelpSupportTeam helpSupportTeam = helpSupportTeamRepository.findByMidAndType(helpSupportDto.getMId(), helpSupportDto.getType())
                .orElse(new HelpSupportTeam());//TODO: do we need this to create if it is not present.
        helpSupportTeam.setValue(helpSupportDto.getValue());
        helpSupportTeam.setUpdatedAt(DateTimeUtils.getCurrentTimeInMills());
//        helpSupportTeam.setStatus(STATUS_ACTIVE);
//        EPayPrincipal ePayPrincipal = EPayIdentityUtil.getUserPrincipal();
//        helpSupportTeam.getUpdatedBy(ePayPrincipal.getUserId());
        helpSupportTeam = helpSupportTeamRepository.save(helpSupportTeam);
        log.info("Updated Help&Support: {}", helpSupportTeam);
        return mapper.mapHelpSupportTeamEntityToResponse(helpSupportTeam);
    }

    /**
     * Is MId exist in the system.
     * @param mId String
     * @return boolean
     */
    public boolean isExistsByMId(String mId) {
        return merchantInfoRepository.existsBymId(mId);
    }
}


package com.epay.merchant.validator;

import com.epay.merchant.dao.HelpSupportDao;
import com.epay.merchant.dto.ErrorDto;
import com.epay.merchant.dto.HelpSupportTeamDto;
import com.epay.merchant.util.ErrorConstants;
import com.epay.merchant.util.MerchantConstant;
import com.epay.merchant.util.enums.HelpSupportType;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.text.MessageFormat;
import java.util.ArrayList;

/**
 * Class Name: HelpSupportValidator
 * *
 * Description: A validator class for user validation requests.
 * Extends the BaseValidator to provide common validation functionality.
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */

@Component
@RequiredArgsConstructor
public class HelpSupportValidator extends BaseValidator {
    private static final LoggerUtility logger = LoggerFactoryUtility.getLogger(HelpSupportValidator.class);
    private final HelpSupportDao helpSupportDao;
    /**
     * Validates the user validation request.
     * * @param helpSupportTeamDto the request object containing user details to be validated.
     */
    public void validateCreateHelpSupportRequest(String mId) {
        logger.debug("HelpSupport validation start for mId: {}", mId);
        errorDtoList = new ArrayList<>();
        checkMandatoryField(mId, "mId");
        validatedAlreadyPresent(mId);
        logger.debug("HelpSupport field validation completed for {}", mId);
    }
    public void validateUpdateHelpSupportRequest(HelpSupportTeamDto helpSupportTeamDto) {
        logger.debug("HelpSupport validation start for HelpSupportTeamDto: {}", helpSupportTeamDto);
        errorDtoList = new ArrayList<>();
        validateMandatoryFields(helpSupportTeamDto);
        validateFieldsValue(helpSupportTeamDto);
        validatedAlreadyPresent(helpSupportTeamDto.getMId());
    }
    /**
     * Validates that all mandatory fields in the request are present.
     * * @param helpSupportTeamDto the request object containing user details to be validated.
     */
    private void validateMandatoryFields(HelpSupportTeamDto helpSupportTeamDto) {
        checkMandatoryField(helpSupportTeamDto.getMId(), "MId");
        checkMandatoryField(helpSupportTeamDto.getValue(), "Value");
        throwIfErrors();
    }
    /**
     * Validates the values of fields in the request object.
     * * @param helpSupportTeamDto the request object containing user details to be validated.
     */
    private void validateFieldsValue(HelpSupportTeamDto helpSupportTeamDto) {
        if(helpSupportTeamDto.getType() == HelpSupportType.EMAIL)
            validateFieldWithRegex(helpSupportTeamDto.getValue(), MerchantConstant.EMAIL_LENGTH, MerchantConstant.EMAIL_REGEX, "Email", "Please check {0} Format or Max length");
        if(helpSupportTeamDto.getType() == HelpSupportType.PHONE_NUMBER)
            validateFieldWithRegex(helpSupportTeamDto.getValue(), MerchantConstant.PHONE_REGEX, "Phone Number", "Please check Phone Number Format for {0}");
        throwIfErrors();
    }

    /**
     * validatedAlreadyPresent
     * @param mId String
     */
    void validatedAlreadyPresent(String mId) {
        if (!helpSupportDao.isExistsByMId(mId)) {
            errorDtoList.add(ErrorDto.builder().errorCode(ErrorConstants.NOT_FOUND_ERROR_CODE).errorMessage(MessageFormat.format(ErrorConstants.NOT_FOUND_ERROR_MESSAGE, "MId")).build());
        }
        throwIfErrors();
    }
}


package com.epay.merchant.repository;

import com.epay.merchant.entity.HelpSupportTeam;
import com.epay.merchant.util.enums.HelpSupportType;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.web.bind.annotation.PathVariable;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

/**
 * Class Name: HelpSupportTeamRepository
 * *
 * Description:
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
public interface HelpSupportTeamRepository extends JpaRepository<HelpSupportTeam, UUID> {

    @Query("""
            SELECT hs
            FROM HelpSupportTeam hs
            LEFT JOIN MerchantInfo m
            ON hs.aggregatorId = m.aggregator WHERE m.mId = :mId
            """)
    List<HelpSupportTeam> findByMid(@Param("mId")String mId);

    @Query("""
            SELECT hs 
            FROM HelpSupportTeam hs 
            LEFT JOIN MerchantInfo m 
            ON hs.aggregatorId = m.aggregator WHERE m.mId = :mId AND hs.type = :type
            """)
    Optional<HelpSupportTeam> findByMidAndType(@Param("mId")String mId, @PathVariable("type") HelpSupportType type);

}
