package com.epay.merchant.controller;

import com.epay.merchant.model.request.HelpSupportRequest;
import com.epay.merchant.model.request.MerchantEntityGroupRequest;
import com.epay.merchant.model.request.OnboardingRequest;
import com.epay.merchant.model.response.*;
import com.epay.merchant.model.request.UserEntityMappingRequest;
import com.epay.merchant.model.response.MerchantEntityGroupResponse;
import com.epay.merchant.model.response.MerchantResponse;
import com.epay.merchant.model.response.MerchantUserResponse;
import com.epay.merchant.model.response.OnboardingResponse;
import com.epay.merchant.service.AdminService;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Pageable;
import org.springframework.data.web.PageableDefault;
import org.springframework.web.bind.annotation.*;

/**
 * Class Name: AdminController
 * *
 * Description:
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@RestController
@RequestMapping("/admin")
@RequiredArgsConstructor
public class AdminController {
    private final LoggerUtility log = LoggerFactoryUtility.getLogger(AdminController.class);
    private final AdminService adminService;

    /**
     * @param onboardingRequest OnboardingDto
     * @return MerchantResponse
     */
    @PostMapping("/onboarding")
    @Operation(summary = "Onboarding Merchant and Merchant Admin user creation API for SBI Admin Usages.", description = "Create Merchant and Merchant Admin User, API can be access by SBI Admin only.")
    public MerchantResponse<OnboardingResponse> onboardingMerchant(@RequestBody OnboardingRequest onboardingRequest) {
        log.info("Onboarding Merchant called : onboardingRequest {}", onboardingRequest);
        return adminService.onboardingMerchant(onboardingRequest);

    }

    /**
     * create Merchant Entity Group
     * @param merchantEntityGroupRequest MerchantEntityGroupRequest
     * @return MerchantResponse
     */
    @PostMapping("/entity")
    @Operation(summary = "Entity Creation for set Of Merchants MIds", description = "SBI Admin will use this API to create Merchant Groups which will named as Entity")
    public MerchantResponse<MerchantEntityGroupResponse> createMerchantEntityGroup(@RequestBody MerchantEntityGroupRequest merchantEntityGroupRequest) {
        log.info("Entity Creation : merchantRequest {}", merchantEntityGroupRequest);
        return adminService.createMerchantEntityGroup(merchantEntityGroupRequest);
    }

    /**
     * Get All User
     * @param mid String
     * @param pageable Pageable
     * @return MerchantResponse
     */
    @GetMapping("/users/{mid}")
    @Operation(summary = "share the all users info for that merchant.", description = "share the all users info for that merchant.")
    public MerchantResponse<MerchantUserResponse> getAllUser(@PathVariable String mid, @PageableDefault(size = 50, page = 0) Pageable pageable) {
        log.info("Received request to get userList based on mid: {}", mid);
        return adminService.getAllMerchantUsers(mid, pageable);
    }

    @PutMapping("/help/{mId}")
    @Operation(summary = "share the all users info for that merchant.", description = "share the all users info for that merchant.")
    public MerchantResponse<HelpSupportResponse> saveHelpSupport(@PathVariable String mId, @RequestBody HelpSupportRequest helpSupportRequest) {
        log.info("Update Help & Support mId[{}] and helpSupportRequest: {}", mId, helpSupportRequest);
        return adminService.saveHelpSupport(mId, helpSupportRequest);
    }

    @PostMapping("/entity/mapping")
    public MerchantResponse<String> userEntityMapping(@RequestBody UserEntityMappingRequest userEntityMappingRequest) {
        log.info("Received request for mapping with details: {}", userEntityMappingRequest);
        return adminService.userEntityMapping(userEntityMappingRequest);
    }
}



package com.epay.merchant.controller;

import com.epay.merchant.model.request.HelpSupportRequest;
import com.epay.merchant.model.request.MerchantEntityGroupRequest;
import com.epay.merchant.model.request.OnboardingRequest;
import com.epay.merchant.model.response.*;
import com.epay.merchant.model.request.UserEntityMappingRequest;
import com.epay.merchant.model.response.MerchantEntityGroupResponse;
import com.epay.merchant.model.response.MerchantResponse;
import com.epay.merchant.model.response.MerchantUserResponse;
import com.epay.merchant.model.response.OnboardingResponse;
import com.epay.merchant.service.AdminService;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Pageable;
import org.springframework.data.web.PageableDefault;
import org.springframework.web.bind.annotation.*;

/**
 * Class Name: AdminController
 * *
 * Description:
 * *
 * Author: Bhoopendra Rajput
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@RestController
@RequestMapping("/admin")
@RequiredArgsConstructor
public class AdminController {
    private final LoggerUtility log = LoggerFactoryUtility.getLogger(AdminController.class);
    private final AdminService adminService;

    /**
     * @param onboardingRequest OnboardingDto
     * @return MerchantResponse
     */
    @PostMapping("/onboarding")
    @Operation(summary = "Onboarding Merchant and Merchant Admin user creation API for SBI Admin Usages.", description = "Create Merchant and Merchant Admin User, API can be access by SBI Admin only.")
    public MerchantResponse<OnboardingResponse> onboardingMerchant(@RequestBody OnboardingRequest onboardingRequest) {
        log.info("Onboarding Merchant called : onboardingRequest {}", onboardingRequest);
        return adminService.onboardingMerchant(onboardingRequest);

    }

    /**
     * create Merchant Entity Group
     * @param merchantEntityGroupRequest MerchantEntityGroupRequest
     * @return MerchantResponse
     */
    @PostMapping("/entity")
    @Operation(summary = "Entity Creation for set Of Merchants MIds", description = "SBI Admin will use this API to create Merchant Groups which will named as Entity")
    public MerchantResponse<MerchantEntityGroupResponse> createMerchantEntityGroup(@RequestBody MerchantEntityGroupRequest merchantEntityGroupRequest) {
        log.info("Entity Creation : merchantRequest {}", merchantEntityGroupRequest);
        return adminService.createMerchantEntityGroup(merchantEntityGroupRequest);
    }

    /**
     * Get All User
     * @param mid String
     * @param pageable Pageable
     * @return MerchantResponse
     */
    @GetMapping("/users/{mid}")
    @Operation(summary = "share the all users info for that merchant.", description = "share the all users info for that merchant.")
    public MerchantResponse<MerchantUserResponse> getAllUser(@PathVariable String mid, @PageableDefault(size = 50, page = 0) Pageable pageable) {
        log.info("Received request to get userList based on mid: {}", mid);
        return adminService.getAllMerchantUsers(mid, pageable);
    }

    @PutMapping("/help/{mId}")
    @Operation(summary = "share the all users info for that merchant.", description = "share the all users info for that merchant.")
    public MerchantResponse<HelpSupportResponse> saveHelpSupport(@PathVariable String mId, @RequestBody HelpSupportRequest helpSupportRequest) {
        log.info("Update Help & Support mId[{}] and helpSupportRequest: {}", mId, helpSupportRequest);
        return adminService.saveHelpSupport(mId, helpSupportRequest);
    }

    @PostMapping("/entity/mapping")
    public MerchantResponse<String> userEntityMapping(@RequestBody UserEntityMappingRequest userEntityMappingRequest) {
        log.info("Received request for mapping with details: {}", userEntityMappingRequest);
        return adminService.userEntityMapping(userEntityMappingRequest);
    }
}


package com.epay.merchant.dao;

import com.epay.merchant.dto.MerchantEntityGroupDto;
import com.epay.merchant.dto.MerchantUserDto;
import com.epay.merchant.dto.OnboardingDto;
import com.epay.merchant.entity.MerchantEntityGroup;
import com.epay.merchant.entity.MerchantInfo;
import com.epay.merchant.mapper.MerchantMapper;
import com.epay.merchant.model.request.OnboardingRequest;
import com.epay.merchant.repository.MerchantEntityGroupRepository;
import com.epay.merchant.repository.MerchantRepository;
import com.epay.merchant.util.enums.MerchantStatus;
import com.epay.merchant.util.enums.UserStatus;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * Class Name: MerchantDAO
 * *
 * Description:
 * *
 * Author: V1017903(bhushan wadekar)
 * <p>
 * Copyright (c) 2024 [State Bank of India]
 * All rights reserved
 * *
 * Version:1.0
 */
@Component
@RequiredArgsConstructor
public class AdminDao {

    private final LoggerUtility log = LoggerFactoryUtility.getLogger(this.getClass());

    private final MerchantRepository merchantRepository;
    private final MerchantUserDao merchantUserDao;
    private final MerchantEntityGroupRepository merchantEntityGroupRepository;
    private final MerchantMapper mapper;

    /**
     * Creating onboarding records in database.
     *
     * @param onboardingRequest OnboardingDto
     * @return OnboardingDto
     */
    @Transactional
    public OnboardingDto onboardingMerchantAndMerchantUser(OnboardingRequest onboardingRequest) {
        // Step 1 : Onboard Merchant
        MerchantInfo merchantInfo = mapper.mapMerchantDtoToEntity(onboardingRequest.getMerchant());
        merchantInfo.setStatus(MerchantStatus.ACTIVE.name());
        merchantInfo = merchantRepository.save(merchantInfo);
        // Step 2 : Onboard Merchant User
        MerchantUserDto merchantUserDto = merchantUserDao.saveMerchantUser(onboardingRequest.getUser(), merchantInfo.getMId());
        // Step 3 : Build Onboarding response
        return OnboardingDto.builder().merchant(mapper.mapMerchantInfoEntityToDto(merchantInfo)).user(merchantUserDto).build();
    }

    public boolean isMerchantExistByMId(String mId) {
        return merchantRepository.existsBymIdAndStatus(mId, MerchantStatus.ACTIVE.name());
    }

    public boolean isMerchantUserExist(String userName, String email, String mobilePhone) {
        return merchantUserDao.existsByUserNameOrEmailOrMobilePhoneAndStatus(userName, email, mobilePhone, UserStatus.ACTIVE);
    }

    public boolean isMerchantUserExistWithRoles(String userName, List<String> roles) {
        return merchantUserDao.existsByUserNameOrEmailOrMobilePhoneAndRoles(userName, roles);
    }

    public boolean isMerchantUserExistWithRoles(UUID userId, List<String> roles) {
        return merchantUserDao.existsByUserIdAndRoles(userId, roles);
    }

    public Page<MerchantUserDto> findAllMerchantUsersByMId(String mId, Pageable pageable) {
        return merchantUserDao.getAllMerchantUsersByMId(mId, pageable);
    }

    public List<String> findMappedEntityMIds(List<String> mIds) {
        return merchantEntityGroupRepository.findExistingMIds(mIds);
    }

    public List<String> findInvalidsMIds(List<String> mIds) {
        List<String> inActiveMIds = new ArrayList<>(mIds);
        List<String> activeMIds = merchantRepository.findActiveMIds(mIds);
        inActiveMIds.removeAll(activeMIds);
        return inActiveMIds;
    }

    public boolean isEntityIdPresent(String entityId) {
        return merchantEntityGroupRepository.existsByEntityId(entityId);
    }

    public MerchantEntityGroupDto saveMerchantEntityGroup(MerchantEntityGroupDto merchantEntityGroupDto) {
        List<MerchantEntityGroup> merchantEntityGroups = merchantEntityGroupDto.getMIds().stream().map(mId -> MerchantEntityGroup.builder().entityId(merchantEntityGroupDto.getEntityId()).mId(mId).build()).collect(Collectors.toList());
        merchantEntityGroupRepository.saveAll(merchantEntityGroups);
        return merchantEntityGroupDto;
    }


    public void updateUserRole(UUID userId, String userName, String entityId) {
        merchantUserDao.updateMerchantUserRole(userId, userName, entityId);
    }
}


