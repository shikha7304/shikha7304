package com.epay.merchant.validator;

import com.epay.merchant.dao.CaptchaDao;
import com.epay.merchant.dto.ErrorDto;
import com.epay.merchant.entity.Captcha;
import com.epay.merchant.model.request.CaptchaRequest;
import com.epay.merchant.util.DateTimeUtils;
import com.epay.merchant.util.ErrorConstants;
import lombok.RequiredArgsConstructor;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Component;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.UUID;

@Component
@RequiredArgsConstructor
public class CaptchaValidator extends BaseValidator {

    private final CaptchaDao captchaDao;

    /**
     * Validates all the mandatory fields present in the request and check for Duplicate RequestId.
     * @param captchaRequest CaptchaRequest
     */
    public void requestValidator(CaptchaRequest captchaRequest) {
        errorDtoList = new ArrayList<>();
        validateMandatoryFields(captchaRequest);
        duplicateCheck(captchaRequest);
    }

    /**
     * Validates captcha expiry & text.
     * @param requestId UUID
     * @param captchaText Hash String
     */
    public void captchaValueValidation(UUID requestId, String captchaText) {
        errorDtoList = new ArrayList<>();
        Captcha captchaDetails = captchaDao.getCaptchaByRequestId(requestId);
        isCaptchaExpiry(DateTimeUtils.isPastDate(captchaDetails.getExpiryTime()));
        matchCaptcha(captchaText, captchaDetails.getCaptchaText());
    }

    private void validateMandatoryFields(CaptchaRequest captchaRequest) {
        checkMandatoryField(captchaRequest.getRequestId(), "RequestId");
        checkMandatoryField(captchaRequest.getRequestType(), "Request Type");
        throwIfErrors();
    }

    private void duplicateCheck(CaptchaRequest captchaRequest) {
        if (captchaDao.existsByRequestId(captchaRequest.getRequestId())) {
            errorDtoList.add(ErrorDto.builder().errorCode(ErrorConstants.INVALID_ERROR_CODE).errorMessage(MessageFormat.format(ErrorConstants.INVALID_ERROR_MESSAGE, "RequestId", "Reason : Duplicate RequestId")).build());
        }
        throwIfErrors();
    }


    private void isCaptchaExpiry(boolean captchaDetails) {
        if (captchaDetails) {
            errorDtoList.add(ErrorDto.builder().errorCode(ErrorConstants.EXPIRY_TIME_ERROR_CODE).errorMessage(MessageFormat.format(ErrorConstants.EXPIRY_TIME_ERROR_MESSAGE, "Captcha")).build());
        }
        throwIfErrors();
    }

    /**
     * Comparing request captchaTextHash with dbCaptchaTextHash
     * @param loginCaptchaImage String
     * @param dbCaptchaTextHash String
     */
    private void matchCaptcha(String loginCaptchaImage, String dbCaptchaTextHash) {
        if (!StringUtils.equals(loginCaptchaImage, dbCaptchaTextHash)) {
            errorDtoList.add(ErrorDto.builder().errorCode(ErrorConstants.NOT_FOUND_ERROR_CODE).errorMessage(MessageFormat.format(ErrorConstants.NOT_FOUND_ERROR_MESSAGE, "Captcha")).build());
        }
        throwIfErrors();
    }

}
