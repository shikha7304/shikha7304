package com.epay.merchant.dao;

import com.epay.merchant.config.MerchantConfig;
import com.epay.merchant.dto.MerchantEmailDto;
import com.epay.merchant.entity.NotificationManagement;
import com.epay.merchant.dto.SmsRequest;
import com.epay.merchant.repository.NotificationManagementRepository;
import com.epay.merchant.util.MerchantConstant;
import com.epay.merchant.util.enums.NotificationType;
import com.sbi.epay.logging.utility.LoggerFactoryUtility;
import com.sbi.epay.logging.utility.LoggerUtility;
import com.sbi.epay.notification.exception.NotificationException;
import com.sbi.epay.notification.model.EmailDto;
import com.sbi.epay.notification.model.SmsDto;
import com.sbi.epay.notification.service.EmailService;
import com.sbi.epay.notification.service.SmsService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.util.concurrent.CompletableFuture;

@Component
@RequiredArgsConstructor
public class NotificationDao {

    private final LoggerUtility log = LoggerFactoryUtility.getLogger(this.getClass());

    private final EmailService emailService;
    private final SmsService smsService;
    private final MerchantConfig merchantConfig;
    private final NotificationManagementRepository notificationManagementRepository;
    private int emailResponse = MerchantConstant.RESPONSE_SUCCESS;
    private int smsResponse = MerchantConstant.RESPONSE_SUCCESS;

    public void sendEmailNotification(MerchantEmailDto merchantEmailDto, NotificationManagement notificationManagement) {
        sendEmail(merchantEmailDto);
        notificationManagement.setNotificationType(NotificationType.EMAIL);
        notificationManagement.setContent(merchantEmailDto.getContent().toString());
        notificationManagement.setStatus(emailResponse);
        notificationManagementRepository.save(notificationManagement);
    }

    public void sendSmsNotification(SmsRequest smsRequest, NotificationManagement notificationManagement) {
        sendSMS(smsRequest);
        notificationManagement.setNotificationType(NotificationType.SMS);
        notificationManagement.setContent(smsRequest.getMessage());
        notificationManagement.setStatus(smsResponse);
        notificationManagementRepository.save(notificationManagement);
    }

    /**
     * Sending email.
     */
    private void sendEmail(MerchantEmailDto merchantEmailDto) {
        CompletableFuture.runAsync(() -> {
            try {
                EmailDto emailDto = getEmailDto(merchantEmailDto);
                emailService.sendEmail(emailDto);
            } catch (NotificationException n) {
                log.error("Error in send Email, merchantEmailDto {}", merchantEmailDto, n);
                emailResponse = MerchantConstant.RESPONSE_FAILURE;
            } catch (Exception e) {
                log.error("Error in send Email, merchantEmailDto {}", merchantEmailDto, e.getMessage());
                emailResponse = MerchantConstant.RESPONSE_FAILURE;
            }
        });
    }

    private void sendSMS(SmsRequest smsRequest) {
        CompletableFuture.runAsync(() -> {
            try {
                SmsDto smsDto = SmsDto.builder().mobileNumber(smsRequest.getMobileNumber()).message(smsRequest.getMessage()).build();
                smsService.sendSMS(smsDto);
            } catch (NotificationException n) {
                log.error("Error in send SMS, smsRequest {}", smsRequest, n);
                smsResponse = MerchantConstant.RESPONSE_FAILURE;
            } catch (Exception e) {
                log.error("Error in send SMS, smsRequest {}", smsRequest, e.getMessage());
                smsResponse = MerchantConstant.RESPONSE_FAILURE;
            }
        });
    }

    private EmailDto getEmailDto(MerchantEmailDto merchantEmailDto) {
        EmailDto emailDto = EmailDto.builder()
                .subject(merchantEmailDto.getEMailType().getSubjectName())
                .from(merchantConfig.getFrom())
                .body(merchantEmailDto.getContent())
                .emailTemplate(merchantEmailDto.getEMailType().getTemplateName()).build();
        if (!merchantConfig.getRecipient().isEmpty()) {
            emailDto.setRecipient(merchantConfig.getRecipient());
            emailDto.setCc(merchantEmailDto.getToEmail());
        } else {
            emailDto.setRecipient(merchantEmailDto.getToEmail());
        }
        return emailDto;
    }
}




    private void sendOtpGenerationNotification(OtpManagement otpManagement, MerchantUserDto merchantUser, String otp) {
        sendEmail(otpManagement, merchantUser, otp);
        sendSms(otpManagement, merchantUser, otp);
    }

    private void sendEmail(OtpManagement otpManagement, MerchantUserDto merchantUser, String otp) {
        NotificationManagement notificationMgmt = buildNotificationManagement(otpManagement);
        MerchantEmailDto merchantEmailDto = MerchantEmailDto.builder().toEmail(merchantUser.getEmail()).content(EmailUtil.generateOtpContent(merchantUser, otp)).eMailType(EmailUtil.getEMailType(otpManagement.getRequestType())).build();
        notificationDao.sendEmailNotification(merchantEmailDto, notificationMgmt);
    }

    private void sendSms(OtpManagement otpManagement, MerchantUserDto merchantUser, String otp) {
        NotificationManagement notificationMgmt = buildNotificationManagement(otpManagement);
        SmsRequest smsRequest = SmsRequest.builder().mobileNumber(merchantUser.getMobilePhone()).message(MessageFormat.format(SmsUtil.getSMSTemplate(otpManagement.getRequestType()), otp, merchantConfig.getOtpExpiryTime())).build();
        notificationDao.sendSmsNotification(smsRequest, notificationMgmt);
    }

    public void validateRequestIdByUserNameAndRequestType(String requestId, String userName, RequestType requestType) {
        MerchantUserDto merchantUser = getMerchantUserDto(userName, requestType);
        OtpManagement otpManagement = otpManagementRepository.findTopByRequestTypeAndUserIdOrderByExpiryTimeDesc(requestType, merchantUser.getId()).orElseThrow(() -> new MerchantException(ErrorConstants.INVALID_ERROR_CODE, MessageFormat.format(ErrorConstants.INVALID_ERROR_MESSAGE, "OTP Verification", "OTP Verification Fail")));
        if (otpManagement.getRequestId().toString().equals(requestId) && otpManagement.isVerified() && !DateTimeUtils.isPastDate(otpManagement.getExpiryTime())) {
            return;
        }
        throw new MerchantException(ErrorConstants.INVALID_ERROR_CODE, MessageFormat.format(ErrorConstants.INVALID_ERROR_MESSAGE, "OTP Verification", "OTP Verification Fail, Please try again"));
    }
}



/**
     * This method will send password notification to user
     * @param  requestType RequestType
     * @param entityId UUID,
     * @param password String
     */
    private void sendNotification(RequestType requestType, UUID entityId, MerchantUserDto merchantUser, String password) {
        sendSms(requestType, merchantUser, entityId);
        sendEmail(requestType, merchantUser, password, entityId);
    }

    private void sendEmail(RequestType requestType, MerchantUserDto merchantUser, String password, UUID entityId) {
        NotificationManagement notificationMgmt = buildNotificationManagement(requestType, entityId);
        String text = RequestType.CHANGE_PASSWORD.equals(requestType) ? "changed" : "reset";
        MerchantEmailDto merchantEmailDto = MerchantEmailDto.builder().toEmail(merchantUser.getEmail()).content(EmailUtil.generateDefaultContent(MessageFormat.format("Password has been {0} successfully, {1} password is {2}", text, text, password))).eMailType(EMailType.PASSWORD_GENERATION).build();
        notificationDao.sendEmailNotification(merchantEmailDto, notificationMgmt);
    }

    private void sendSms(RequestType requestType, MerchantUserDto merchantUser, UUID entityId) {
        NotificationManagement notificationMgmt = buildNotificationManagement(requestType, entityId);
        SmsRequest smsRequest = SmsRequest.builder().mobileNumber(merchantUser.getMobilePhone()).message(SmsUtil.USER_PASSWORD_REGENERATION_REQUEST).build();
        notificationDao.sendSmsNotification(smsRequest, notificationMgmt);
    }

    private static NotificationManagement buildNotificationManagement(RequestType requestType, UUID entityId) {
        return NotificationManagement.builder().requestType(requestType.getName()).entityId(entityId).entityName(NotificationEntityType.PASSWORD_MANAGEMENT).build();
    }

}
